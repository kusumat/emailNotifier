<?xml version="1.0" encoding="ISO-8859-1"?>
<project name="kony" basedir="." default="main" xmlns:ivy="antlib:org.apache.ivy.ant">
    <property name="ivy.install.version" value="2.4.0"/>
    <property name="ivy.home" value="${ant.library.dir}"/>
    <property name="ivy.jar.file" value="${ivy.home}/ivy.jar"/>

    <target name="main"
            depends="init-ivy,property,projectprop-xml-update,wipe"
            description="-> generate properties, update projectprop xml, generate ivy.xml, retrieve artifacts, wipes out kony plugins from plugins directory"/>

    <target name="download-ivy" unless="offline">
        <get src="http://repo2.maven.org/maven2/org/apache/ivy/ivy/${ivy.install.version}/ivy-${ivy.install.version}.jar"
             dest="${ivy.jar.file}"
             usetimestamp="true"/>
    </target>

    <target name="init-ivy" depends="download-ivy">
        <path id="ivy.lib.path">
            <fileset dir="${ivy.home}" includes="*.jar"/>
        </path>
        <taskdef resource="org/apache/ivy/ant/antlib.xml"
                 uri="antlib:org.apache.ivy.ant" classpathref="ivy.lib.path"/>
    </target>

    <target name="property" description="-> prepare property files">
        <property environment="env"/>
        <!-- Set of properties that depend on chosen target platform -->
        <condition property="separator" value="\" else="/">
            <os family="windows"/>
        </condition>
        <condition property="androidMobileNative" value="${env.ANDROID_MOBILE_NATIVE}" else="false">
            <isset property="env.ANDROID_MOBILE_NATIVE"/>
        </condition>
        <condition property="androidMobileSPA" value="${env.ANDROID_MOBILE_SPA}" else="false">
            <isset property="env.ANDROID_MOBILE_SPA"/>
        </condition>
        <condition property="androidTabletNative" value="${env.ANDROID_TABLET_NATIVE}" else="false">
            <isset property="env.ANDROID_TABLET_NATIVE"/>
        </condition>
        <condition property="androidTabletSPA" value="${env.ANDROID_TABLET_SPA}" else="false">
            <isset property="env.ANDROID_TABLET_SPA"/>
        </condition>
        <condition property="iosWatchNative" value="${env.APPLE_WATCH_EXTENSION}" else="false">
            <isset property="env.APPLE_WATCH_EXTENSION"/>
        </condition>
        <condition property="iosMobileNative" value="${env.IOS_MOBILE_NATIVE}" else="false">
            <isset property="env.IOS_MOBILE_NATIVE"/>
        </condition>
        <condition property="iosMobileSPA" value="${env.IOS_MOBILE_SPA}" else="false">
            <isset property="env.IOS_MOBILE_SPA"/>
        </condition>
        <condition property="iosTabletNative" value="${env.IOS_TABLET_NATIVE}" else="false">
            <isset property="env.IOS_TABLET_NATIVE"/>
        </condition>
        <condition property="iosTabletSPA" value="${env.IOS_TABLET_SPA}" else="false">
            <isset property="env.IOS_TABLET_SPA"/>
        </condition>
        <!-- Window Phone 8 is not supported by Microsoft anymore, ignoring this channel -->
        <condition property="windowsMobileWindowsPhone8" value="${env.WINDOWS8_MOBILE_NATIVE}" else="false">
            <isset property="env.WINDOWS8_MOBILE_NATIVE"/>
        </condition>
        <condition property="windowsMobileWindowsPhone81S" value="${env.WINDOWS81_MOBILE_NATIVE}" else="false">
            <isset property="env.WINDOWS81_MOBILE_NATIVE"/>
        </condition>
        <condition property="windowsMobileWindowsPhone10" value="${env.WINDOWS10_MOBILE_NATIVE}" else="false">
            <isset property="env.WINDOWS10_MOBILE_NATIVE"/>
        </condition>
        <condition property="windowsMobileSPA" value="${env.WINDOWS_MOBILE_SPA}" else="false">
            <isset property="env.WINDOWS_MOBILE_SPA"/>
        </condition>
        <condition property="windowsTabletWindows81" value="${env.WINDOWS81_TABLET_NATIVE}" else="false">
            <isset property="env.WINDOWS81_TABLET_NATIVE"/>
        </condition>
        <condition property="windowsTabletWindows10" value="${env.WINDOWS10_TABLET_NATIVE}" else="false">
            <isset property="env.WINDOWS10_TABLET_NATIVE"/>
        </condition>
        <condition property="windowsTabletSPA" value="${env.WINDOWS_TABLET_SPA}" else="false">
            <isset property="env.WINDOWS_TABLET_SPA"/>
        </condition>
        <condition property="windowsDesktopKiosk" value="${env.WINDOWS_DESKTOP_KIOSK}" else="false">
            <isset property="env.WINDOWS_DESKTOP_KIOSK"/>
        </condition>
        <condition property="desktopWeb" value="${env.DESKTOP_WEB}" else="false">
            <isset property="env.DESKTOP_WEB"/>
        </condition>
        <condition property="blackberryMobileSPA" value="${env.BLACKBERRY_MOBILE_SPA}" else="false">
            <isset property="env.BLACKBERRY_MOBILE_SPA"/>
        </condition>
        <condition property="blackberryMobileHybridSPA" value="${env.BLACKBERRY_MOBILE_HYBRID_SPA}" else="false">
            <isset property="env.BLACKBERRY_MOBILE_HYBRID_SPA"/>
        </condition>

        <!-- Set of common properties -->
        <condition property="projectName" value="${env.PROJECT_NAME}" else="">
            <isset property="env.PROJECT_NAME"/>
        </condition>
        <condition property="projectAppId" value="${env.projectAppId}" else="">
            <isset property="env.projectAppId"/>
        </condition>
        <condition property="androidHome" value="${env.ANDROID_HOME}" else="">
            <isset property="env.ANDROID_HOME"/>
        </condition>
        <condition property="workspace" value="${env.PROJECT_WORKSPACE}" else="">
            <isset property="env.WORKSPACE"/>
        </condition>
        <condition property="visualizerHome" value="${env.VISUALIZER_HOME}" else="">
            <isset property="env.VISUALIZER_HOME"/>
        </condition>
        <condition property="buildMode" value="release" else="${env.BUILD_MODE}">
            <and>
                <isset property="env.BUILD_MODE"/>
                <equals arg1="${env.BUILD_MODE}" arg2="release-protected"/>
            </and>
        </condition>
        <condition property="appVersion" value="${env.APP_VERSION}" else="">
            <isset property="env.APP_VERSION"/>
        </condition>
        <condition property="defaultLocale" value="${env.DEFAULT_LOCALE}" else="">
            <isset property="env.DEFAULT_LOCALE"/>
        </condition>
        <condition property="androidPackageName" value="${env.ANDROID_PACKAGE_NAME}" else="">
            <isset property="env.ANDROID_PACKAGE_NAME"/>
        </condition>
        <condition property="androidVersionCode" value="${env.ANDROID_VERSION_CODE}" else="">
            <isset property="env.ANDROID_VERSION_CODE"/>
        </condition>
        <condition property="iosBundleVersion" value="${env.IOS_BUNDLE_VERSION}" else="">
            <isset property="env.IOS_BUNDLE_VERSION"/>
        </condition>
        <condition property="cloudUsername" value="${env.CLOUD_USERNAME}" else="">
            <isset property="env.CLOUD_USERNAME"/>
        </condition>
        <condition property="cloudPassword" value="${env.CLOUD_PASSWORD}" else="">
            <isset property="env.CLOUD_PASSWORD"/>
        </condition>
        <condition property="cloudAccountId" value="${env.CLOUD_ACCOUNT_ID}" else="">
            <isset property="env.CLOUD_ACCOUNT_ID"/>
        </condition>
        <condition property="domainParam" value="${env.domainParam}" else="">
            <isset property="env.domainParam"/>
        </condition>
        <condition property="fabricUrl" value="https://manage.${env.CLOUD_DOMAIN}" else="https://manage.kony.com">
            <isset property="env.CLOUD_DOMAIN"/>
        </condition>
        <condition property="fabricEnvironmentName" value="${env.FABRIC_ENV_NAME}" else="">
            <isset property="env.FABRIC_ENV_NAME"/>
        </condition>
        <condition property="fabricAppName" value="${env.FABRIC_APP_NAME}" else="">
            <isset property="env.FABRIC_APP_NAME"/>
        </condition>
        <!-- set of protected build properties -->
        <condition property="protectedIosBuild" value="true" else="false">
            <and>
                <equals arg1="${env.BUILD_MODE}" arg2="release-protected"/>
                <or>
                    <equals arg1="${iosMobileNative}" arg2="true"/>
                    <equals arg1="${iosTabletNative}" arg2="true"/>
                </or>
            </and>
        </condition>
        <condition property="protectedAndroidBuild" value="true" else="false">
            <and>
                <equals arg1="${env.BUILD_MODE}" arg2="release-protected"/>
                <or>
                    <equals arg1="${androidMobileNative}" arg2="true"/>
                    <equals arg1="${androidTabletNative}" arg2="true"/>
                </or>
            </and>
        </condition>
        <property name="visInner" value="${visualizerHome}${separator}Kony_Visualizer_Enterprise"/>
        <property name="visBundles"
                  value="${visInner}${separator}configuration${separator}org.eclipse.osgi${separator}bundles"/>
        <property name="imageMagicHome" value="${visualizerHome}${separator}ImageMagick"/>
        <property name="eclipseEquinoxFileName" value="org.eclipse.equinox.launcher_1.3.0.v20130327-1440.jar"/>
        <property name="eclipseEquinoxPath"
                  value="${visInner}${separator}plugins${separator}${eclipseEquinoxFileName}"/>

        <propertyfile file="HeadlessBuild-Global.properties" comment="Autogenerated file">
            <entry key="android.home" value="${androidHome}"/>
            <entry key="workspace.location" value="${workspace}"/>
            <entry key="imagemagic.home" value="${imageMagicHome}"/>
            <entry key="eclipse.equinox.path" value="${eclipseEquinoxPath}"/>
        </propertyfile>

        <propertyfile file="HeadlessBuild.properties" comment="Autogenerated file">
            <entry key="project.name" value="${projectName}"/>
            <!-- Mode been hardcoded to 0 to fit requirement of publishing Fabric application with Fabric CLI -->
            <entry key="mode" value="0"/>
            <entry key="build.mode" value="${buildMode}"/>
            <entry key="appid" value="${projectAppId}"/>
            <entry key="version" value="${appVersion}"/>
            <entry key="default_locale" value="${defaultLocale}"/>
            <entry key="android.packagename" value="${androidPackageName}"/>
            <entry key="android.versioncode" value="${androidVersionCode}"/>
            <entry key="ios.bundleversion" value="${iosBundleVersion}"/>
            <entry key="cloud.username" value="${cloudUsername}"/>
            <!--APPFACT-545, direct assignment leads in adding escape character '\' with all special characters.
                Instead using replace task to add proper value of password -->
            <entry key="cloud.password" value="CLOUD_PASSWORD"/>
            <entry key="account.id" value="${cloudAccountId}"/>
            <entry key="cloud.environment" value="${domainParam}"/>
            <entry key="mobilefabric.url" value="${fabricUrl}"/>
            <entry key="environment.name" value="${fabricEnvironmentName}"/>
            <entry key="mf.appname" value="${fabricAppName}"/>
            <entry key="iphone" value="${iosMobileNative}"/>
            <entry key="android" value="${androidMobileNative}"/>
            <entry key="windowsphone8" value="${windowsMobileWindowsPhone8}"/>
            <entry key="windowsphone81s" value="${windowsMobileWindowsPhone81S}"/>
            <entry key="windowsphone10" value="${windowsMobileWindowsPhone10}"/>
            <entry key="spa.iphone" value="${iosMobileSPA}"/>
            <entry key="spa.android" value="${androidMobileSPA}"/>
            <entry key="spa.blackberry" value="${blackberryMobileSPA}"/>
            <entry key="spa.winphone" value="${windowsMobileSPA}"/>
            <entry key="spa.hybrid.blackberry" value="${blackberryMobileHybridSPA}"/>
            <entry key="ipad" value="${iosTabletNative}"/>
            <entry key="androidtablet" value="${androidTabletNative}"/>
            <entry key="windows8.1" value="${windowsTabletWindows81}"/>
            <entry key="windows10" value="${windowsTabletWindows10}"/>
            <entry key="spa.ipad" value="${iosTabletSPA}"/>
            <entry key="spa.androidtablet" value="${androidTabletSPA}"/>
            <entry key="spa.windowstablet" value="${windowsTabletSPA}"/>
            <entry key="desktop_kiosk" value="${windowsDesktopKiosk}"/>
            <entry key="desktopweb" value="${desktopWeb}"/>
            <entry key="iphonewatch" value="${iosWatchNative}"/>
            <entry key="mac.ipaddress" value=""/>
            <entry key="mac.username" value=""/>
            <entry key="mac.password" value=""/>
            <entry key="keychain.password" value=""/>
            <entry key="development.team" value=""/>
            <entry key="method" value=""/>
            <entry key="genipaiphone" value="false"/>
            <entry key="genipaipad" value="false"/>
            <entry key="binaries.location" value=""/>
            <entry key="combinewar.middlewarearchive" value=""/>
            <entry key="combinewar.context" value=""/>
            <entry key="combinewar.war" value="false"/>
            <entry key="combinewar.ear" value="false"/>
            <entry key="combinewar.dependencylibraries" value=""/>
            <!-- Protected build mode options -->
            <entry key="protectedmodeenabled.ios" value="${protectedIosBuild}"/>
            <entry key="protectedmodeenabled.android" value="${protectedAndroidBuild}"/>
        </propertyfile>

        <!--APPFACT-545: propertyfile appends escape character to Special Characters, workaround to use exact same password -->
        <replace file="HeadlessBuild.properties" token="CLOUD_PASSWORD" value="${cloudPassword}"/>
    </target>

    <!--APPFACT-861: For 7.x projects we are updating directly in projectprop.xml for protected builds enablement.-->
    <target name="projectprop-xml-update" description="-> updating xml attributes with params">
        <replaceregexp file="projectprop.xml" match="(.*)protectedmodeenabled_android(.*)$"
                       replace="\1protectedmodeenabled_android&quot; value=&quot;${protectedAndroidBuild}&quot;/>"
                       flags="gm"/>
        <replaceregexp file="projectprop.xml" match="(.*)protectedmodeenabled_ios(.*)$"
                       replace="\1protectedmodeenabled_ios&quot; value=&quot;${protectedIosBuild}&quot;/>" flags="gm"/>
    </target>

    <target name="plugins" description="-> generate ivy.xml from konyplugins.xml">
        <condition property="plugin.os.ver" value="mac64" else="win64">
            <os family="mac"/>
        </condition>
        <copy file="konyplugins.xml" tofile="ivy.xml" overwrite="true"/>
        <replace file="ivy.xml">
            <replacetoken><![CDATA[<plugins>]]></replacetoken>
            <replacevalue><![CDATA[<ivy-module version="2.4">
    <info organisation="com.kony" module="AppFactory"/>
    <dependencies>]]></replacevalue>
        </replace>
        <replace file="ivy.xml" token="pluginInfo" value="dependency"/>
        <replace file="ivy.xml" token="plugin-id" value="name"/>
        <replace file="ivy.xml" token="version-no" value="rev"/>
        <replaceregexp file="ivy.xml" match="plugin-name.*$" replace="/>" flags="gm"/>
        <replace file="ivy.xml">
            <replacetoken><![CDATA[</plugins>]]></replacetoken>
            <replacevalue><![CDATA[    </dependencies>
</ivy-module>]]></replacevalue>
        </replace>
        <replace file="ivy.xml" token="win64" value="${plugin.os.ver}"/>
        <replace file="ivy.xml" token="mac64" value="${plugin.os.ver}"/>
    </target>

    <target name="retrieve" depends="plugins" description="-> retrieve dependencies with ivy">
        <ivy:retrieve pattern="${visInner}/dropins/[artifact]_[revision].[ext]"/>
    </target>

    <target name="wipe" depends="clean,retrieve,plugins" description="-> wipes out kony plugins from plugins directory">
        <delete>
            <fileset dir="${visInner}/plugins">
                <include name="com.pat.*.jar"/>
                <include name="com.kony.*.jar"/>
            </fileset>
        </delete>
    </target>

    <target name="clean" description="-> clean dropins and bundles directory">
        <delete dir="${visInner}/dropins"/>
        <delete dir="${visBundles}"/>
    </target>

    <target name="clean-all" depends="clean" description="-> clean dropins directory and ivy cache">
        <ivy:cleancache/>
    </target>
</project>
