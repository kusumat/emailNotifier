<?xml version="1.0" encoding="ISO-8859-1"?>
<project name="kony" basedir="." default="main" xmlns:ivy="antlib:org.apache.ivy.ant">
    <property name="ivy.install.version" value="2.4.0"/>
    <property name="ivy.home" value="${ant.library.dir}"/>
    <property name="ivy.jar.file" value="${ivy.home}/ivy.jar"/>

    <target name="main"
            depends="init-ivy,property,wipe"
            description="-> generate properties, generate ivy.xlm, retrieve artifacts, delete duplicates"/>

    <target name="download-ivy" unless="offline">
        <get src="http://repo2.maven.org/maven2/org/apache/ivy/ivy/${ivy.install.version}/ivy-${ivy.install.version}.jar"
             dest="${ivy.jar.file}"
             usetimestamp="true"/>
    </target>

    <target name="init-ivy" depends="download-ivy">
        <path id="ivy.lib.path">
            <fileset dir="${ivy.home}" includes="*.jar"/>
        </path>
        <taskdef resource="org/apache/ivy/ant/antlib.xml"
                 uri="antlib:org.apache.ivy.ant" classpathref="ivy.lib.path"/>
    </target>

    <target name="property" description="-> prepare property files">
        <property environment="env"/>

        <!-- Set of properties that depend on chosen target platform -->
        <condition property="separator" value="\" else="/">
            <os family="windows"/>
        </condition>
        <condition property="androidMobileNative" value="${env.ANDROID_MOBILE_NATIVE}" else="false">
            <isset property="env.ANDROID_MOBILE_NATIVE"/>
        </condition>
        <condition property="androidMobileSPA" value="${env.ANDROID_MOBILE_SPA}" else="false">
            <isset property="env.ANDROID_MOBILE_SPA"/>
        </condition>
        <condition property="androidTabletNative" value="${env.ANDROID_TABLET_NATIVE}" else="false">
            <isset property="env.ANDROID_TABLET_NATIVE"/>
        </condition>
        <condition property="androidTabletSPA" value="${env.ANDROID_TABLET_SPA}" else="false">
            <isset property="env.ANDROID_TABLET_SPA"/>
        </condition>
        <condition property="iosWatchNative" value="${env.IOS_WATCH_NATIVE}" else="false">
            <isset property="env.IOS_WATCH_NATIVE"/>
        </condition>
        <condition property="iosMobileNative" value="${env.IOS_MOBILE_NATIVE}" else="false">
            <isset property="env.IOS_MOBILE_NATIVE"/>
        </condition>
        <condition property="iosMobileSPA" value="${env.IOS_MOBILE_SPA}" else="false">
            <isset property="env.IOS_MOBILE_SPA"/>
        </condition>
        <condition property="iosTabletNative" value="${env.IOS_TABLET_NATIVE}" else="false">
            <isset property="env.IOS_TABLET_NATIVE"/>
        </condition>
        <condition property="iosTabletSPA" value="${env.IOS_TABLET_SPA}" else="false">
            <isset property="env.IOS_TABLET_SPA"/>
        </condition>
        <condition property="windowsMobileWindowsPhone81S" value="${env.WINDOWS81S_MOBILE_NATIVE}" else="false">
            <isset property="env.WINDOWS81S_MOBILE_NATIVE"/>
        </condition>
        <condition property="windowsMobileWindowsPhone10" value="${env.WINDOWS10_MOBILE_NATIVE}" else="false">
            <isset property="env.WINDOWS10_MOBILE_NATIVE"/>
        </condition>
        <condition property="windowsMobileSPA" value="${env.WINDOWS_MOBILE_SPA}" else="false">
            <isset property="env.WINDOWS_MOBILE_SPA"/>
        </condition>
        <condition property="windowsTabletWindows81" value="${env.WINDOWS81_TABLET_NATIVE}" else="false">
            <isset property="env.WINDOWS81_TABLET_NATIVE"/>
        </condition>
        <condition property="windowsTabletWindows10" value="${env.WINDOWS_TABLET_WINDOWS10}" else="false">
            <isset property="env.WINDOWS_TABLET_WINDOWS10"/>
        </condition>
        <condition property="windowsTabletSPA" value="${env.WINDOWS_TABLET_SPA}" else="false">
            <isset property="env.WINDOWS_TABLET_SPA"/>
        </condition>
        <condition property="windowsDesktopKiosk" value="${env.WINDOWS_DESKTOP_KIOSK}" else="false">
            <isset property="env.WINDOWS_DESKTOP_KIOSK"/>
        </condition>
        <condition property="windowsDesktopKiosk" value="${env.WINDOWS_DESKTOP_WEB}" else="false">
            <isset property="env.WINDOWS_DESKTOP_WEB"/>
        </condition>
        <condition property="blackberryMobileSPA" value="${env.BLACKBERRY_MOBILE_SPA}" else="false">
            <isset property="env.BLACKBERRY_MOBILE_SPA"/>
        </condition>
        <condition property="blackberryMobileHybridSPA" value="${env.BLACKBERRY_MOBILE_HYBRID_SPA}" else="false">
            <isset property="env.BLACKBERRY_MOBILE_HYBRID_SPA"/>
        </condition>

        <!-- Set of common properties -->
        <property name="android.home" value="${env.ANDROID_HOME}"/>
        <property name="workspace.location" value="${env.WORKSPACE}"/>
        <property name="vis.root" value="${env.VISUALIZER_HOME}"/>
        <property name="vis.inner" value="${vis.root}${separator}Kony_Visualizer_Enterprise"/>
        <property name="vis.bundles"
                  value="${vis.inner}${separator}configuration${separator}org.eclipse.osgi${separator}bundles"/>
        <property name="imagemagic.home" value="${vis.root}${separator}ImageMagick"/>
        <property name="eclipse.equinox.file.name" value="org.eclipse.equinox.launcher_1.3.0.v20130327-1440.jar"/>
        <property name="eclipse.equinox.path"
                  value="${vis.inner}${separator}plugins${separator}${eclipse.equinox.file.name}"/>

        <propertyfile file="HeadlessBuild-Global.properties" comment="Autogenerated file">
            <entry key="android.home" value="${android.home}"/>
            <entry key="workspace.location" value="${workspace.location}"/>
            <entry key="imagemagic.home" value="${imagemagic.home}"/>
            <entry key="eclipse.equinox.path" value="${eclipse.equinox.path}"/>
        </propertyfile>

        <property environment="env"/>
        <propertyfile file="HeadlessBuild.properties" comment="Autogenerated file">
            <entry key="project.name" value="${env.PROJECT_NAME}"/>
            <!-- Mode been hardcoded to 0 to fit requirement of publishing Fabric application with Fabric CLI -->
            <entry key="mode" value="0"/>
            <entry key="build.mode" value="${env.BUILD_MODE}"/>
            <entry key="appid" value="${env.PROJECT_NAME}"/>
            <entry key="version" value="1.0.0"/>
            <entry key="map_google_key" value=""/>
            <entry key="default_locale" value=""/>
            <entry key="android.packagename" value="com.orgname.${env.PROJECT_NAME}"/>
            <entry key="android.versioncode" value="1"/>
            <entry key="ios.bundleversion" value="1.0"/>
            <entry key="cloud.username" value="${env.CLOUD_NAME}"/>
            <entry key="cloud.password" value="${env.CLOUD_PASS}"/>
            <entry key="mobilefabric.url" value="${env.FABRIC_URL}"/>
            <entry key="environment.name" value="${env.FABRIC_ENVIRONMENT_NAME}"/>
            <entry key="account.id" value="${env.FABRIC_ACCOUNT_ID}"/>
            <entry key="mf.appname" value="${env.FABRIC_APP_NAME}"/>
            <entry key="iphone" value="${iosMobileNative}"/>
            <entry key="android" value="${androidMobileNative}"/>
            <entry key="windowsphone8" value="false"/>
            <entry key="windowsphone81s" value="${windowsMobileWindowsPhone81S}"/>
            <entry key="windowsphone10" value="${windowsMobileWindowsPhone10}"/>
            <entry key="spa.iphone" value="${iosMobileSPA}"/>
            <entry key="spa.android" value="${androidMobileSPA}"/>
            <entry key="spa.blackberry" value="${blackberryMobileSPA}"/>
            <entry key="spa.winphone" value="${windowsMobileSPA}"/>
            <entry key="spa.hybrid.blackberry" value="${blackberryMobileHybridSPA}"/>
            <entry key="ipad" value="${iosTabletNative}"/>
            <entry key="androidtablet" value="${androidTabletNative}"/>
            <entry key="windows8.1" value="${windowsTabletWindows81}"/>
            <entry key="windows10" value="${windowsTabletWindows10}"/>
            <entry key="spa.ipad" value="${iosTabletSPA}"/>
            <entry key="spa.androidtablet" value="${androidTabletSPA}"/>
            <entry key="spa.windowstablet" value="${windowsTabletSPA}"/>
            <entry key="desktop_kiosk" value="${windowsDesktopKiosk}"/>
            <entry key="desktopweb" value="${windowsDesktopKiosk}"/>
            <entry key="iphonewatch" value="${iosWatchNative}"/>
            <entry key="mac.ipaddress" value=""/>
            <entry key="mac.username" value=""/>
            <entry key="mac.password" value=""/>
            <entry key="keychain.password" value=""/>
            <entry key="development.team" value=""/>
            <entry key="method" value=""/>
            <entry key="genipaiphone" value="false"/>
            <entry key="genipaipad" value="false"/>
            <entry key="binaries.location" value=""/>
            <entry key="combinewar.middlewarearchive" value=""/>
            <entry key="combinewar.context" value=""/>
            <entry key="combinewar.war" value="false"/>
            <entry key="combinewar.ear" value="false"/>
            <entry key="combinewar.dependencylibraries" value=""/>
        </propertyfile>
    </target>

    <target name="plugins" description="-> generate ivy.xml from konyplugins.xml">
        <condition property="plugin.os.ver" value="mac64" else="win64">
            <os family="mac"/>
        </condition>
        <copy file="konyplugins.xml" tofile="ivy.xml" overwrite="true"/>
        <replace file="ivy.xml">
            <replacetoken><![CDATA[<plugins>]]></replacetoken>
            <replacevalue><![CDATA[<ivy-module version="2.4">
    <info organisation="com.kony" module="AppFactory"/>
    <dependencies>]]></replacevalue>
        </replace>
        <replace file="ivy.xml" token="pluginInfo" value="dependency"/>
        <replace file="ivy.xml" token="plugin-id" value="name"/>
        <replace file="ivy.xml" token="version-no" value="rev"/>
        <replaceregexp file="ivy.xml" match="plugin-name.*$" replace="/>" flags="gm"/>
        <replace file="ivy.xml"> 
            <replacetoken><![CDATA[</plugins>]]></replacetoken>
            <replacevalue><![CDATA[    </dependencies>
</ivy-module>]]></replacevalue>
        </replace>
        <replace file="ivy.xml" token="win64" value="${plugin.os.ver}"/>
	</target>

    <target name="retrieve" depends="plugins" description="-> retrieve dependencies with ivy">
        <ivy:retrieve pattern="${vis.inner}/dropins/[artifact]_[revision].[ext]"/>
    </target>

    <target name="wipe" depends="clean,retrieve,plugins" description="-> wipe duplacates in plugins directory">
        <delete>
            <fileset dir="${vis.inner}/plugins" includes="**/*">
                <present targetdir="${vis.inner}/dropins" />
            </fileset>
        </delete>
    </target>

    <target name="clean" description="-> clean dropins and bundles directory">
        <delete dir="${vis.inner}/dropins"/>
        <delete dir="${vis.bundles}"/>
    </target>

    <target name="clean-all" depends="clean" description="-> clean dropins directory and ivy cache">
        <ivy:cleancache/>
    </target>
</project>
